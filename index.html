<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Disponibilit√©s - BiLBOBASSO</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .status-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .status-btn {
            padding: 12px 24px;
            border: 3px solid;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        #btn-available {
            border-color: #4CAF50;
            color: #4CAF50;
            background: #4CAF50;
            color: white;
        }
        
        #btn-unavailable {
            border-color: #f44336;
            color: #f44336;
            background: transparent;
        }
        
        .calendar-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        
        .nav-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .nav-btn:hover {
            background: #0056b3;
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .current-month {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: bold;
            color: #495057;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .calendar-day {
            display: flex;
            flex-direction: column;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            min-height: 70px;
            position: relative;
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
            background: #f8f9fa;
        }
        
        .day-number {
            text-align: center;
            font-weight: bold;
            color: #333;
            padding: 4px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .half-days-container {
            display: flex;
            flex: 1;
            gap: 2px;
            padding: 2px;
        }
        
        .half-day {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            min-height: 35px;
            border: 1px solid #ddd;
        }
        
        .half-day:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .half-day.morning {
            background: #f0f8ff;
        }
        
        .half-day.afternoon {
            background: #fff8f0;
        }
        
        .half-day.available {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .half-day.unavailable {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }
        
        .summary {
            display: none;
            background: #e8f4fd;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .calendar {
                gap: 2px;
                padding: 10px;
            }
            
            .calendar-day {
                min-height: 55px;
            }
            
            .half-day {
                font-size: 9px;
                min-height: 25px;
            }
            
            .day-number {
                font-size: 11px;
                padding: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Mes Disponibilit√©s BiLBOBASSO</h1>
        
        <form id="availabilityForm">
            <!-- Nom -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Nom Pr√©nom</label>
                <input type="text" id="artistName" required 
                       style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px;"
                       placeholder="Pr√©nom Nom">
            </div>

            <!-- S√©lection du statut -->
            <div style="margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;">S√©lectionnez votre statut :</h3>
                <div class="status-buttons">
                    <button type="button" id="btn-available" class="status-btn" onclick="setStatus('available')">
                        ‚úÖ Disponible
                    </button>
                    <button type="button" id="btn-unavailable" class="status-btn" onclick="setStatus('unavailable')">
                        ‚ùå Indisponible
                    </button>
                </div>
                <p style="color: #666; font-size: 14px; text-align: center; margin-top: 10px;">
                    Puis cliquez sur les cr√©neaux AM/PM dans le calendrier
                </p>
            </div>

            <!-- L√©gende -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #f0f8ff;"></div>
                    <span>AM (9h-13h)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff8f0;"></div>
                    <span>PM (14h-18h)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>Disponible</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>Indisponible</span>
                </div>
            </div>

            <!-- Navigation du calendrier -->
            <div class="calendar-navigation">
                <button type="button" class="nav-btn" onclick="changeMonth(-1)">‚Üê Mois pr√©c√©dent</button>
                <span class="current-month" id="currentMonth"></span>
                <button type="button" class="nav-btn" onclick="changeMonth(1)">Mois suivant ‚Üí</button>
            </div>

            <!-- Calendrier dynamique -->
            <div class="calendar" id="calendar">
                <!-- G√©n√©r√© dynamiquement -->
            </div>

            <!-- R√©sum√© -->
            <div id="summary" class="summary">
                <div id="summaryContent"></div>
            </div>

            <!-- Notes -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Notes (optionnel)</label>
                <textarea id="notes" rows="3" 
                          style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; resize: vertical;"
                          placeholder="Commentaires, contraintes particuli√®res..."></textarea>
            </div>

            <!-- Bouton d'envoi -->
            <button type="submit" class="submit-btn">
                üì§ Envoyer mes disponibilit√©s
            </button>
        </form>
    </div>

    <script>
let currentStatus = 'available';
let availabilities = {}; // Format: "2025-06-01-morning": "available"
let currentDate = new Date(2025, 5, 1); // Juin 2025 (mois 0-index√©)

const monthNames = [
    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
];

const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

// Pr√©fillage automatique AM√âLIOR√â
function prefillName() {
    const nameField = document.getElementById('artistName');
    if (!nameField) return;
    
    let artistName = '';
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        artistName = urlParams.get('nom') || urlParams.get('name') || '';
        
        if (!artistName && window.location.hash) {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            artistName = hashParams.get('nom') || hashParams.get('name') || '';
        }
        
        if (!artistName) {
            const url = window.location.href;
            const patterns = [
                /[?&#]nom=([^&#]+)/i,
                /[?&#]name=([^&#]+)/i,
                /[?&#]n=([^&#]+)/i
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    artistName = decodeURIComponent(match[1].replace(/\+/g, ' '));
                    break;
                }
            }
        }
        
        if (artistName) {
            artistName = artistName.trim();
            nameField.value = artistName;
            nameField.style.background = '#e8f5e8';
            nameField.style.borderColor = '#4CAF50';
            
            const parent = nameField.parentNode;
            if (!parent.querySelector('.prefill-indicator')) {
                const indicator = document.createElement('div');
                indicator.innerHTML = '‚úÖ Nom pr√©rempli: ' + artistName;
                indicator.className = 'prefill-indicator';
                indicator.style.cssText = 'color: #4CAF50; font-size: 12px; margin-top: 5px; font-weight: bold;';
                parent.appendChild(indicator);
            }
            
            console.log('‚úÖ Pr√©fillage r√©ussi:', artistName);
        }
        
    } catch (e) {
        console.error('Erreur pr√©fillage:', e);
    }
}

// G√©n√©rer le calendrier dynamiquement
function generateCalendar() {
    const calendar = document.getElementById('calendar');
    const currentMonthSpan = document.getElementById('currentMonth');
    
    // Mettre √† jour le titre du mois
    currentMonthSpan.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    
    // Vider le calendrier
    calendar.innerHTML = '';
    
    // Ajouter les en-t√™tes des jours
    dayNames.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = day;
        calendar.appendChild(header);
    });
    
    // Calculer le premier jour du mois et le nombre de jours
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    // Premier jour de la semaine (0 = dimanche, 1 = lundi, etc.)
    let startDay = firstDay.getDay();
    startDay = startDay === 0 ? 6 : startDay - 1; // Convertir pour que lundi = 0
    
    // Ajouter les jours du mois pr√©c√©dent pour compl√©ter la premi√®re semaine
    for (let i = startDay - 1; i >= 0; i--) {
        const prevMonthDay = new Date(year, month, -i);
        createDayElement(prevMonthDay, true);
    }
    
    // Ajouter tous les jours du mois actuel
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        createDayElement(date, false);
    }
    
    // Compl√©ter avec les jours du mois suivant
    const totalCells = calendar.children.length - 7; // -7 pour les en-t√™tes
    const remainingCells = 42 - totalCells; // 6 semaines * 7 jours = 42
    for (let day = 1; day <= remainingCells; day++) {
        const nextMonthDay = new Date(year, month + 1, day);
        createDayElement(nextMonthDay, true);
    }
}

// Cr√©er un √©l√©ment jour avec demi-journ√©es
function createDayElement(date, isOtherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = `calendar-day ${isOtherMonth ? 'other-month' : ''}`;
    
    // Num√©ro du jour
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = date.getDate();
    dayElement.appendChild(dayNumber);
    
    // Container pour les demi-journ√©es c√¥te √† c√¥te
    const halfDaysContainer = document.createElement('div');
    halfDaysContainer.className = 'half-days-container';
    
    // Demi-journ√©e matin (AM)
    const morning = document.createElement('div');
    morning.className = 'half-day morning';
    morning.textContent = 'AM';
    morning.onclick = () => toggleHalfDay(date, 'morning');
    halfDaysContainer.appendChild(morning);
    
    // Demi-journ√©e apr√®s-midi (PM)
    const afternoon = document.createElement('div');
    afternoon.className = 'half-day afternoon';
    afternoon.textContent = 'PM';
    afternoon.onclick = () => toggleHalfDay(date, 'afternoon');
    halfDaysContainer.appendChild(afternoon);
    
    dayElement.appendChild(halfDaysContainer);
    
    // Appliquer l'√©tat existant si disponible
    const dateStr = formatDate(date);
    const morningKey = `${dateStr}-morning`;
    const afternoonKey = `${dateStr}-afternoon`;
    
    if (availabilities[morningKey]) {
        morning.classList.add(availabilities[morningKey]);
    }
    if (availabilities[afternoonKey]) {
        afternoon.classList.add(availabilities[afternoonKey]);
    }
    
    document.getElementById('calendar').appendChild(dayElement);
}

// Changer de mois
function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    generateCalendar();
}

// Formater la date en YYYY-MM-DD
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Changer le statut s√©lectionn√©
function setStatus(status) {
    currentStatus = status;
    
    const btnAvailable = document.getElementById('btn-available');
    const btnUnavailable = document.getElementById('btn-unavailable');
    
    if (btnAvailable && btnUnavailable) {
        btnAvailable.style.background = 'transparent';
        btnAvailable.style.color = '#4CAF50';
        btnUnavailable.style.background = 'transparent';
        btnUnavailable.style.color = '#f44336';
        
        if (status === 'available') {
            btnAvailable.style.background = '#4CAF50';
            btnAvailable.style.color = 'white';
        } else if (status === 'unavailable') {
            btnUnavailable.style.background = '#f44336';
            btnUnavailable.style.color = 'white';
        }
    }
}

// Basculer une demi-journ√©e
function toggleHalfDay(date, period) {
    const dateStr = formatDate(date);
    const key = `${dateStr}-${period}`;
    
    // Trouver l'√©l√©ment dans le DOM
    const halfDayElements = document.querySelectorAll(`.half-day.${period}`);
    let targetElement = null;
    
    halfDayElements.forEach(el => {
        const parentDay = el.closest('.calendar-day');
        const dayNumber = parentDay.querySelector('.day-number').textContent;
        if (parseInt(dayNumber) === date.getDate()) {
            targetElement = el;
        }
    });
    
    if (!targetElement) return;
    
    // Retirer les anciens styles
    targetElement.classList.remove('available', 'unavailable');
    
    // Appliquer le nouveau statut
    availabilities[key] = currentStatus;
    targetElement.classList.add(currentStatus);
    
    updateSummary();
}

// Grouper les demi-journ√©es par p√©riodes
function groupConsecutiveHalfDays(availabilities) {
    const periods = [];
    const grouped = { available: [], unavailable: [] };
    
    // Grouper par statut
    for (let key in availabilities) {
        const status = availabilities[key];
        grouped[status].push(key);
    }
    
    // Traiter chaque statut
    Object.keys(grouped).forEach(status => {
        if (grouped[status].length === 0) return;
        
        const sorted = grouped[status].sort();
        let currentPeriod = null;
        
        sorted.forEach(key => {
            const [dateStr, period] = key.split('-');
            const date = dateStr;
            
            if (!currentPeriod || currentPeriod.endDate !== date || 
                (currentPeriod.endPeriod === 'morning' && period === 'afternoon' && currentPeriod.endDate === date)) {
                
                if (currentPeriod) {
                    periods.push(currentPeriod);
                }
                
                currentPeriod = {
                    startDate: date,
                    startPeriod: period,
                    endDate: date,
                    endPeriod: period,
                    status: status === 'available' ? 'Disponible' : 'Indisponible'
                };
            } else {
                currentPeriod.endDate = date;
                currentPeriod.endPeriod = period;
            }
        });
        
        if (currentPeriod) {
            periods.push(currentPeriod);
        }
    });
    
    return periods;
}

// Mettre √† jour le r√©sum√©
function updateSummary() {
    const summary = document.getElementById('summary');
    const content = document.getElementById('summaryContent');
    
    if (summary && content) {
        if (Object.keys(availabilities).length > 0) {
            summary.style.display = 'block';
            
            const periods = groupConsecutiveHalfDays(availabilities);
            
            let html = '<strong>Cr√©neaux qui seront envoy√©s :</strong><br><br>';
            
            periods.forEach(period => {
                const periodText = period.startPeriod === 'morning' ? 'AM' : 'PM';
                const endPeriodText = period.endPeriod === 'morning' ? 'AM' : 'PM';
                
                if (period.startDate === period.endDate && period.startPeriod === period.endPeriod) {
                    html += `üìÖ ${period.startDate} ${periodText} : ${period.status}<br>`;
                } else {
                    html += `üìÖ Du ${period.startDate} ${periodText} au ${period.endDate} ${endPeriodText} : ${period.status}<br>`;
                }
            });
            
            html += `<br><em>Total : ${periods.length} p√©riode(s) pour ${Object.keys(availabilities).length} cr√©neau(x)</em>`;
            content.innerHTML = html;
        } else {
            summary.style.display = 'none';
        }
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    prefillName();
    setTimeout(prefillName, 500);
    generateCalendar();
    
    // Gestion du formulaire
    const form = document.getElementById('availabilityForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nameField = document.getElementById('artistName');
            const notesField = document.getElementById('notes');
            
            if (!nameField || !notesField) {
                alert('Erreur : champs du formulaire non trouv√©s');
                return;
            }
            
            const artistName = nameField.value;
            const comments = notesField.value;
            
            if (Object.keys(availabilities).length === 0) {
                alert('Veuillez s√©lectionner au moins un cr√©neau !');
                return;
            }
            
            const periods = groupConsecutiveHalfDays(availabilities);
            const promises = [];
            
            periods.forEach(period => {
                const recordData = {
                    fields: {
                        "Contact text": artistName,
                        "D√©but disponibilit√©": period.startDate,
                        "Fin disponibilit√©": period.endDate,
                        "P√©riode": period.startPeriod === 'morning' ? 'Matin' : 'Apr√®s-midi',
                        "Statut_Disponibilite": period.status,
                        "Commentaires": comments,
                        "Statut": "Re√ßu"
                    }
                };
                
                const promise = fetch('https://api.airtable.com/v0/appfsMAdTCEaXSYfK/Disponibilit√©s √©quipes', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer patsLl5ZuaJRMM4uE.4719daf1e76068a691bce1dfcd1c77fc6453488a6da3cd23ea12f899b7fd81d4',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(recordData)
                }).then(response => response.json().then(data => response));
                
                promises.push(promise);
            });
            
            Promise.all(promises)
                .then(responses => {
                    const allSuccessful = responses.every(response => response.ok);
                    
                    if (allSuccessful) {
                        alert(`Disponibilit√©s enregistr√©es avec succ√®s !\n${periods.length} p√©riode(s) envoy√©e(s) pour ${Object.keys(availabilities).length} cr√©neau(x).`);
                        form.reset();
                        availabilities = {};
                        updateSummary();
                        generateCalendar(); // R√©g√©n√©rer pour effacer les s√©lections
                    } else {
                        throw new Error('Certains envois ont √©chou√©');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'envoi : ' + error.message);
                });
        });
    }
});
    </script>
</body>
</html>
